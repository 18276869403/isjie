(function(win) {
	win.szqbl = win.szqbl || {};

	//内容中的插图
	win.szqbl.bindContentUploadImage = function(path, fkid) {
		//为了内容图片显示正常这里加上项目目录
		path = '/upload_images/' + path + "/" + fkid;
		return contextPath + '/admin/file/uploadImage.do?path=' +
			path + '&isTimePath=1&fkid=' + fkid + '&fktype=content&exists=1';
	};

	win.szqbl.bindUploadImage = function(opid, fkid, thumb, path, callback) {
		if (!path)
			path = "000";
		layui.upload.render({
			elem : "#upload_" + opid,
			url : contextPath + '/admin/file/uploadImage.do',
			data : {
				path : '/upload_images/' + path + "/" + fkid + "/" + opid,
				fkid : fkid,
				fktype : opid
			},
			multiple : false,
			number : 1,
			size : 20480, //20M
			exts : 'jpeg|jpg|png|gif|bmp',
			accept : 'images',
			acceptMime : 'image/*',
			field : 'file',
			done : function(res) {
				if (res.state) {
					if (callback) {
						callback(res.image);
					} else {
						$("#" + opid).val(res.image.id + "#" + res.image.path + "#" + res.image.pathThumb);
						$("#img_" + opid).attr("src", contextPath + ("0" == thumb ? res.image.path : res.image.pathThumb));
					}
					layer.msg("上传成功");
				} else {
					layer.msg("上传失败，请联系管理员。");
				}
			},
			error : function() {
				layer.msg("上传失败，请联系管理员。");
			}
		});
	};

	win.szqbl.getUploadImageId = function(opid, fkid) {
		if ($("." + opid).val() == $("." + opid + "Old").val())
			return $("." + opid).val(); 
		else
			return $("." + opid).val() + "@" + $("." + opid + "Old").val();
	};

	win.szqbl.getUploadImage = function(imgid, thumb) {
		if (imgid.indexOf("#") > 0) {
			var tmps = imgid.split("#");
			if (tmps.length >= 3) {
				if ("0" == thumb) {
					return tmps[1];
				} else {
					return tmps[2];
				}
			} else if (tmps.length == 2) {
				return tmps[1];
			}
		}
		return imgid;
	};

	win.szqbl.bindUploadImages = function(opid, fkid, thumb, path) {
		if (!path)
			path = "000";
		upload.render({
			elem : "#upload_" + opid,
			url : contextPath + '/admin/file/uploadImage.do',
			data : {
				path : '/upload_images/' + path + "/" + fkid + "/" + opid,
				fkid : fkid,
				fktype : opid
			},
			multiple : false,
			number : 1,
			size : 20480, //20M
			exts : 'jpeg|jpg|png|gif|bmp',
			accept : 'images',
			acceptMime : 'image/*',
			field : 'file',
			done : function(res) {
				if (res.state) {
					//移除无图提醒
					if ($("#" + opid).val() == "") {
						$("#noimg_" + opid).remove();
					}
					$("#" + opid).val($("#" + opid).val() + ";" +
						res.image.id + "#" + res.image.path + "#" + res.image.pathThumb);
					$("#upload_" + opid).before('<div style="float:left;margin-right: 5px;"><img src="' +
						contextPath + ("0" == thumb ? res.image.path : res.image.pathThumb) +
						'" class="layui-upload-img" width="300px" id="' +
						res.image.id +
						'" height="150px"> <i class="layui-icon img_del" style="cursor:pointer;color:red; float: right;font-size:30px;top:0;margin-left:270px;position: absolute;">&#xe640;</i></div>');
					layer.msg("上传成功");
				} else {
					layer.msg("上传失败，请联系管理员。");
				}
			},
			error : function() {
				layer.msg("上传失败，请联系管理员。");
			}
		});

		$("body").on("click", ".img_del", function() {
			var _this = $(this);
			layer.confirm('删除不可恢复，确定删除图片吗？', {
				icon : 3,
				title : '提示信息'
			}, function(index) {
				var id = $("#" + opid).val();
				var imgid = _this.parent().find("img").attr("id");
				if (id.indexOf(";" + imgid + ";") >= 0) {
					id = id.replace(";" + imgid + ";", ";");
				} else if (id.indexOf(imgid + ";") >= 0) {
					id = id.replace(imgid + ";", "");
				} else if (id.indexOf(";" + imgid) >= 0) {
					id = id.replace(";" + imgid, "");
				} else if (id.indexOf(imgid) >= 0) {
					id = id.replace(imgid, "");
				}
				$("#" + opid).val(id);
				$.get(contextPath + '/admin/file/delImage.do?id=' + imgid, function(res) {
					if (res.state) {
						_this.parent().hide(1000);
						setTimeout(function() {
							_this.parent().remove();
						}, 950);
						layer.close(index);
						layer.msg("删除成功");
					}
				});
			});
		});
	};
	
	win.szqbl.bindUploadattach = function(deviceCode, type, attachment, upstatus,oldfile, callback) {
		$("#file").fileupload({
	        url : contextPath + '/admin/file/uploadattach.do',
	        multiple : false,
	        formData : function (from) {
	 			return [{name : "path",value:"/upload_attach/" + deviceCode + "/" + type}]
	        },
	        done : function(e, data){//当文件上传成功后调用这个回调函数
		        if(data.result.state) {	
		        	layer.msg("上传成功");
		            // 上传成功：
		            $("."+upstatus+"").html(data.result.qfileName+"   "+data.result.msg);
		            $("#"+attachment).val(data.result.path);
		            $("#"+oldfile).val(data.result.path);
		        } else {
		            // 上传失败：
		        	layer.msg("上传失败，请联系管理员。");
		            $("."+upstatus+"").html("<span style='color:red;'>"+data.result.msg+"</span>");
		        }
	        },
		    progress: function (e, data) {//上传进度
		        var progress = parseInt(data.loaded / data.total * 100, 10);
		        $("."+upstatus+"").html("正在上传..."+progress+"%");
		    }
		})
	  };
	
}(window));