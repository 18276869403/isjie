/*
 * 省 市 区 多级联动
 */
(function(win) {
	win.szqbl = win.szqbl || {};
	win.szqbl.area = {};
	win.szqbl.bindAreaSelect = function(filterProv, filterCity, filterArea, fourCallback, callback, selects) {
		win.szqbl.area.filterProv = filterProv;
		win.szqbl.area.filterCity = filterCity;
		win.szqbl.area.filterArea = filterArea;
		win.szqbl.area.fourCallback = fourCallback;
		win.szqbl.area.callback = callback;

		layui.form.on('select(' + filterProv + ')', function(data) { //监听下拉选
			$("." + win.szqbl.area.filterArea).children("option").remove();
			win.szqbl.area.provName = $(data.elem[data.elem.selectedIndex]).text();
			win.szqbl.area.cityId = '';
			win.szqbl.area.cityName = '';
			win.szqbl.area.areaId = '';
			win.szqbl.area.areaName = '';
			win.szqbl.area.provId = win.szqbl.area.loadData(filterProv, filterCity, function(cid, cname) {
				win.szqbl.area.cityId = cid;
				win.szqbl.area.cityName = cname;
				win.szqbl.area.areaId = '';
				win.szqbl.area.areaName = '';
				win.szqbl.area.loadData(filterCity, filterArea, function(aid, aname) {
					win.szqbl.area.areaId = aid;
					win.szqbl.area.areaName = aname;
					if (fourCallback)
						fourCallback(win.szqbl.area.provId, win.szqbl.area.cityId, win.szqbl.area.areaId);
				})
			})

		});
		layui.form.on('select(' + filterCity + ')', function(data) {
			win.szqbl.area.cityName = $(data.elem[data.elem.selectedIndex]).text();
			win.szqbl.area.areaId = '';
			win.szqbl.area.areaName = '';
			win.szqbl.area.cityId = win.szqbl.area.loadData(filterCity,
				filterArea, function(aid, aname) {
					win.szqbl.area.areaId = aid;
					win.szqbl.area.areaName = aname;
					if (fourCallback)
						fourCallback(win.szqbl.area.provId, win.szqbl.area.cityId, win.szqbl.area.areaId);
				})
		});
		layui.form.on('select(' + filterArea + ')', function(data) {
			win.szqbl.area.areaId = $("." + filterArea).val();
			win.szqbl.area.areaName = $(data.elem[data.elem.selectedIndex]).text();
			if (fourCallback)
				fourCallback(win.szqbl.area.provId, win.szqbl.area.cityId, win.szqbl.area.areaId);
		});
		//初始加载
		win.szqbl.area.loadData(null, filterProv, function(pid, pname) {
			win.szqbl.area.provId = pid;
			win.szqbl.area.provName = pname;
			win.szqbl.area.loadData(filterProv, filterCity, function(cid, cname) {
				win.szqbl.area.cityId = cid;
				win.szqbl.area.cityName = cname;
				win.szqbl.area.loadData(filterCity, filterArea, function(aid, aname) {
					win.szqbl.area.areaId = aid;
					win.szqbl.area.areaName = aname;
					if (selects) {
						if (selects.provId)
							win.szqbl.area.provId = selects.provId;
						if (selects.cityId)
							win.szqbl.area.cityId = selects.cityId;
						if (selects.areaId)
							win.szqbl.area.areaId = selects.areaId;
					}
					if (fourCallback)
						fourCallback(win.szqbl.area.provId, win.szqbl.area.cityId, win.szqbl.area.areaId);
				}, selects ? selects.areaId : null)
			}, selects ? selects.cityId : null)
		}, selects ? selects.provId : null);
	};
	win.szqbl.area.getData = function() {
		return {
			provId : win.szqbl.area.provId,
			provName : win.szqbl.area.provName,
			cityId : win.szqbl.area.cityId,
			cityName : win.szqbl.area.cityName,
			areaId : win.szqbl.area.areaId,
			areaName : win.szqbl.area.areaName
		};
	}
	win.szqbl.area.loadData = function(filterPar, filter, callback, select) {
		var tip = filter == win.szqbl.area.filterProv ? "请选择省" : (filter == win.szqbl.area.filterCity ? "请选择市" : "请选择区");
		var parid = "";
		if (filterPar) {
			parid = $("." + filterPar).val();
			if (parid == "") {
				$("." + filter).children("option").remove();
				$("." + filter).append("<option value=''>" + tip + "</option>");
				layui.form.render('select');
				return parid;
			}
		}
		$("." + filter).children("option").remove();
		$.ajax({
			type : "get",
			url : contextPath + "/admin/area/getArea.do",
			data : {
				parid : parid
			},
			success : function(data) {
				var id = "";
				var text = "";
				if (data.length > 1) {
					$("." + filter).append("<option value=''>" + tip + "</option>");
				} else if (data.length == 1) {
					id = data[0].id;
					text = data[0].text;
				}
				for (var i = 0; i < data.length; i++) {
					if (select && data[i].id == select) {
						id = data[i].id ;
						text = data[i].text ;
						$("." + filter).append("<option value='" + data[i].id + "' selected>" + data[i].text + "</option>");
					} else {
						$("." + filter).append("<option value='" + data[i].id + "'>" + data[i].text + "</option>");
					}
				}
				if (callback)
					callback(id, text);
				layui.form.render('select');
			}
		});
		return parid;
	}
}(window));