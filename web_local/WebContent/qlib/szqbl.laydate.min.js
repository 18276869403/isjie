(function(win) {
	win.szqbl = win.szqbl || {};
	szqbl.laydate = {};
	//回调方式 标签内: done="mydone()"
	//代码里: szqbl.laydate.mydone = function(value, date, endDate){}
	
	layui.use(['laydate','util'], function() {
		$ = layui.jquery;
		//可共用laydate 使用方法同laydate,在标签上定义laydate属性
		//<input class="layui-input layui-input-laydate" type="month"-->>类型月份   max="M-1"-->>最大月份是当前月份减1 done="mydone()"-->>方法见本页第5行    value="2017-07"-->>默认月份>
		//demo:<input type="datetime" class="layui-input layui-input-laydate" value="${item.date}/>"/>
		lay('.layui-input-laydate').each(function() {
			var _this = this;
			var format = $(_this).attr("format");
			var types = [ 'date', 'datetime', 'year', 'month', 'time' ];
			var type = $(_this).attr("type");
			if (!type || types.indexOf(type) == -1)
				type = 'date';
			$(_this).attr("type","text");
			var val = $(_this).attr("value");
			if(!val) val = "";
			var now = new Date();
			var min = $(_this).attr("min");

			var y = now.getFullYear(),
				M = now.getMonth() + 1,
				d = now.getDate(),
				H = now.getHours(),
				m = now.getMinutes(),
				s = now.getSeconds();
			
			if (min) {
				if (min.indexOf("M") != -1) {
					var _M = eval(min);
					while (_M > 12) {
						y++;
						_M -= 12
					}
					while (_M < 0) {
						y--;
						_M += 12
					}
					if (_M == 0) {
						y--;
						_M = 12
					}
					if (_M.length == 1) {
						_M = "0" + _M
					}
					min = y + "-" + _M + "-" + d + " " + H + ":" + m + ":" + s
				}
				if (!new Date(min)) {
					min = y + "-" + M + "-" + d + " " + H + ":" + m + ":" + s
				}
			} else {
				min = "1900-1-1"
			}
			var max = $(_this).attr("max");
			if (max) {
				if (max.indexOf("M") != -1) {
					var _M = eval(max);
					while (_M > 12) {
						y++;
						_M -= 12
					}
					while (_M < 0) {
						y--;
						_M += 12
					}
					if (_M == 0) {
						y--;
						_M = 12
					}
					if (_M.length == 1) {
						_M = "0" + _M
					}
					max = y + "-" + _M + "-" + d + " " + H + ":" + m + ":" + s
				}
				if (!new Date(max)) {
					max = y + "-" + M + "-" + d + " " + H + ":" + m + ":" + s
				}
			} else {
				max = "2099-12-31"
			}
			
			var date = new Date(val.replace(' CST','').replace(/-/g, "/"));
			if(isNaN(date.getDate())){
				val = y + "/" + M + "/" + d + " " + H + ":" + m + ":" + s;
			}else{
				if (val.indexOf("M-") == 0 || val.indexOf("M+") == 0) {
					var _M = eval(val);
					while (_M > 12) {
						y++;
						_M -= 12
					}
					while (_M < 0) {
						y--;
						_M += 12
					}
					if (_M == 0) {
						y--;
						_M = 12
					}
					if (_M.length == 1) {
						_M = "0" + _M
					}
					val = y + "/" + _M + "/" + d + " " + H + ":" + m + ":" + s;
					$(_this).val(val);
				}
				val = val.replace(' CST','').replace(/-/g, "/");
			}
			
			//'date', 'datetime', 'year', 'month', 'time' 
			if(!format){
				switch(types.indexOf(type)){
				case 0: format = "yyyy-MM-dd";break;
				case 1: format = "yyyy-MM-dd HH:mm:ss";break;
				case 2: format = "yyyy";break;
				case 3: format = "yyyy-MM";break;
				case 4: format = "HH:mm:ss";break;
				}
			}
			val = layui.util.toDateString(new Date(val), format);
			
			//开始渲染
			layui.laydate.render({
				elem: _this,
				trigger: 'click',
				type : type,
				value: val,
				format:format,
				max : max,
				min : min,
				lang : $(_this).attr('lang') || 'cn',
				ready : function(value, date, endDate){
					var func = $(_this).attr("ready");
					if(func){
						eval("szqbl.laydate."+func.split("(")[0]+"(value, date, endDate)");
					}},
				change : function(value, date, endDate){
					var func = $(_this).attr("change");
					if(func){
						eval("szqbl.laydate."+func.split("(")[0]+"(value, date, endDate)");
					}},
				done : function(value, date, endDate){
					var func = $(_this).attr("done");
					if(func){
						eval("szqbl.laydate."+func.split("(")[0]+"(value, date, endDate)");
				}},
			});
		});
		
	});
}(window));
Date.prototype.format = function(fmt) {
	var o = {
		"M+" : this.getMonth() + 1, //月份 
		"d+" : this.getDate(), //日 
		"h+" : this.getHours(), //小时 
		"m+" : this.getMinutes(), //分 
		"s+" : this.getSeconds(), //秒 
		"q+" : Math.floor((this.getMonth() + 3) / 3), //季度 
		"S" : this.getMilliseconds() //毫秒 
	};
	if (/(y+)/.test(fmt))
		fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
	for (var k in o)
		if (new RegExp("(" + k + ")").test(fmt))
			fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
	return fmt;
};